#include <pic32mx.h>
#include <math.h>
#include "display.h"

#define DISPLAY_CHANGE_TO_COMMAND_MODE (PORTFCLR = 0x10)
#define DISPLAY_CHANGE_TO_DATA_MODE (PORTFSET = 0x10)

#define DISPLAY_ACTIVATE_RESET (PORTGCLR = 0x200)
#define DISPLAY_DO_NOT_RESET (PORTGSET = 0x200)

#define DISPLAY_ACTIVATE_VDD (PORTFCLR = 0x40)
#define DISPLAY_ACTIVATE_VBAT (PORTFCLR = 0x20)

#define DISPLAY_TURN_OFF_VDD (PORTFSET = 0x40)
#define DISPLAY_TURN_OFF_VBAT (PORTFSET = 0x20)

// From example project
char textbuffer[4][16];
uint8_t font[] = {
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    94,
    0,
    0,
    0,
    0,
    0,
    0,
    4,
    3,
    4,
    3,
    0,
    0,
    0,
    36,
    126,
    36,
    36,
    126,
    36,
    0,
    0,
    36,
    74,
    255,
    82,
    36,
    0,
    0,
    0,
    70,
    38,
    16,
    8,
    100,
    98,
    0,
    0,
    52,
    74,
    74,
    52,
    32,
    80,
    0,
    0,
    0,
    0,
    4,
    3,
    0,
    0,
    0,
    0,
    0,
    0,
    126,
    129,
    0,
    0,
    0,
    0,
    0,
    0,
    129,
    126,
    0,
    0,
    0,
    0,
    42,
    28,
    62,
    28,
    42,
    0,
    0,
    0,
    8,
    8,
    62,
    8,
    8,
    0,
    0,
    0,
    0,
    0,
    128,
    96,
    0,
    0,
    0,
    0,
    8,
    8,
    8,
    8,
    8,
    0,
    0,
    0,
    0,
    0,
    0,
    96,
    0,
    0,
    0,
    0,
    64,
    32,
    16,
    8,
    4,
    2,
    0,
    0,
    62,
    65,
    73,
    65,
    62,
    0,
    0,
    0,
    0,
    66,
    127,
    64,
    0,
    0,
    0,
    0,
    0,
    98,
    81,
    73,
    70,
    0,
    0,
    0,
    0,
    34,
    73,
    73,
    54,
    0,
    0,
    0,
    0,
    14,
    8,
    127,
    8,
    0,
    0,
    0,
    0,
    35,
    69,
    69,
    57,
    0,
    0,
    0,
    0,
    62,
    73,
    73,
    50,
    0,
    0,
    0,
    0,
    1,
    97,
    25,
    7,
    0,
    0,
    0,
    0,
    54,
    73,
    73,
    54,
    0,
    0,
    0,
    0,
    6,
    9,
    9,
    126,
    0,
    0,
    0,
    0,
    0,
    102,
    0,
    0,
    0,
    0,
    0,
    0,
    128,
    102,
    0,
    0,
    0,
    0,
    0,
    0,
    8,
    20,
    34,
    65,
    0,
    0,
    0,
    0,
    20,
    20,
    20,
    20,
    0,
    0,
    0,
    0,
    65,
    34,
    20,
    8,
    0,
    0,
    0,
    2,
    1,
    81,
    9,
    6,
    0,
    0,
    0,
    28,
    34,
    89,
    89,
    82,
    12,
    0,
    0,
    0,
    126,
    9,
    9,
    126,
    0,
    0,
    0,
    0,
    127,
    73,
    73,
    54,
    0,
    0,
    0,
    0,
    62,
    65,
    65,
    34,
    0,
    0,
    0,
    0,
    127,
    65,
    65,
    62,
    0,
    0,
    0,
    0,
    127,
    73,
    73,
    65,
    0,
    0,
    0,
    0,
    127,
    9,
    9,
    1,
    0,
    0,
    0,
    0,
    62,
    65,
    81,
    50,
    0,
    0,
    0,
    0,
    127,
    8,
    8,
    127,
    0,
    0,
    0,
    0,
    65,
    127,
    65,
    0,
    0,
    0,
    0,
    0,
    32,
    64,
    64,
    63,
    0,
    0,
    0,
    0,
    127,
    8,
    20,
    99,
    0,
    0,
    0,
    0,
    127,
    64,
    64,
    64,
    0,
    0,
    0,
    127,
    2,
    4,
    2,
    127,
    0,
    0,
    0,
    127,
    6,
    8,
    48,
    127,
    0,
    0,
    0,
    0,
    62,
    65,
    65,
    62,
    0,
    0,
    0,
    0,
    127,
    9,
    9,
    6,
    0,
    0,
    0,
    0,
    62,
    65,
    97,
    126,
    64,
    0,
    0,
    0,
    127,
    9,
    9,
    118,
    0,
    0,
    0,
    0,
    38,
    73,
    73,
    50,
    0,
    0,
    0,
    1,
    1,
    127,
    1,
    1,
    0,
    0,
    0,
    0,
    63,
    64,
    64,
    63,
    0,
    0,
    0,
    31,
    32,
    64,
    32,
    31,
    0,
    0,
    0,
    63,
    64,
    48,
    64,
    63,
    0,
    0,
    0,
    0,
    119,
    8,
    8,
    119,
    0,
    0,
    0,
    3,
    4,
    120,
    4,
    3,
    0,
    0,
    0,
    0,
    113,
    73,
    73,
    71,
    0,
    0,
    0,
    0,
    127,
    65,
    65,
    0,
    0,
    0,
    0,
    2,
    4,
    8,
    16,
    32,
    64,
    0,
    0,
    0,
    0,
    65,
    65,
    127,
    0,
    0,
    0,
    4,
    2,
    1,
    2,
    4,
    0,
    0,
    0,
    64,
    64,
    64,
    64,
    64,
    64,
    0,
    0,
    0,
    1,
    2,
    4,
    0,
    0,
    0,
    0,
    0,
    48,
    72,
    40,
    120,
    0,
    0,
    0,
    0,
    127,
    72,
    72,
    48,
    0,
    0,
    0,
    0,
    48,
    72,
    72,
    0,
    0,
    0,
    0,
    0,
    48,
    72,
    72,
    127,
    0,
    0,
    0,
    0,
    48,
    88,
    88,
    16,
    0,
    0,
    0,
    0,
    126,
    9,
    1,
    2,
    0,
    0,
    0,
    0,
    80,
    152,
    152,
    112,
    0,
    0,
    0,
    0,
    127,
    8,
    8,
    112,
    0,
    0,
    0,
    0,
    0,
    122,
    0,
    0,
    0,
    0,
    0,
    0,
    64,
    128,
    128,
    122,
    0,
    0,
    0,
    0,
    127,
    16,
    40,
    72,
    0,
    0,
    0,
    0,
    0,
    127,
    0,
    0,
    0,
    0,
    0,
    120,
    8,
    16,
    8,
    112,
    0,
    0,
    0,
    0,
    120,
    8,
    8,
    112,
    0,
    0,
    0,
    0,
    48,
    72,
    72,
    48,
    0,
    0,
    0,
    0,
    248,
    40,
    40,
    16,
    0,
    0,
    0,
    0,
    16,
    40,
    40,
    248,
    0,
    0,
    0,
    0,
    112,
    8,
    8,
    16,
    0,
    0,
    0,
    0,
    72,
    84,
    84,
    36,
    0,
    0,
    0,
    0,
    8,
    60,
    72,
    32,
    0,
    0,
    0,
    0,
    56,
    64,
    32,
    120,
    0,
    0,
    0,
    0,
    56,
    64,
    56,
    0,
    0,
    0,
    0,
    56,
    64,
    32,
    64,
    56,
    0,
    0,
    0,
    0,
    72,
    48,
    48,
    72,
    0,
    0,
    0,
    0,
    24,
    160,
    160,
    120,
    0,
    0,
    0,
    0,
    100,
    84,
    84,
    76,
    0,
    0,
    0,
    0,
    8,
    28,
    34,
    65,
    0,
    0,
    0,
    0,
    0,
    126,
    0,
    0,
    0,
    0,
    0,
    0,
    65,
    34,
    28,
    8,
    0,
    0,
    0,
    0,
    4,
    2,
    4,
    2,
    0,
    0,
    0,
    120,
    68,
    66,
    68,
    120,
    0,
    0,
};

uint8_t displayBuff[] = {
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
};

// From example project
void quicksleep(int cyc)
{
    int i;
    for (i = cyc; i > 0; i--)
        ;
}

// From example project
uint8_t spi_send_recv(uint8_t data)
{
    while (!(SPI2STAT & 0x08))
        ;
    SPI2BUF = data;
    while (!(SPI2STAT & 0x01))
        ;
    return SPI2BUF;
}

// From example project
void display_init(void)
{
    DISPLAY_CHANGE_TO_COMMAND_MODE;
    quicksleep(10);
    DISPLAY_ACTIVATE_VDD;
    quicksleep(1000000);

    spi_send_recv(0xAE);
    DISPLAY_ACTIVATE_RESET;
    quicksleep(10);
    DISPLAY_DO_NOT_RESET;
    quicksleep(10);

    spi_send_recv(0x8D);
    spi_send_recv(0x14);

    spi_send_recv(0xD9);
    spi_send_recv(0xF1);

    DISPLAY_ACTIVATE_VBAT;
    quicksleep(10000000);

    spi_send_recv(0xA1);
    spi_send_recv(0xC8);

    spi_send_recv(0xDA);
    spi_send_recv(0x20);

    spi_send_recv(0xAF);

    display_clear();
}

// From example project, slightly modified
void display_debug(volatile int *const addr)
{
    num32asc(&textbuffer[1][6], (int)addr);
    num32asc(&textbuffer[2][6], *addr);
    display_string(1, "Addr");
    display_string(2, "Data");
    display_buffer(0, 128, displayBuff);
}

// Author: Olof, modified from example project
void display_string(int line, char *s)
{
    int i, j, k;
    if (line < 0 || line >= 4)
        return;
    if (!s)
        return;

    for (i = 0; i < 16; i++)
    {
        if (*s)
        {
            textbuffer[line][i] = *s;
            s++;
        }
        else
        {
            textbuffer[line][i] = 0x80;
        }
    }
    int c;
    for (i = 0; i < 4; i++)
    {
        DISPLAY_CHANGE_TO_COMMAND_MODE;
        spi_send_recv(0x22);
        spi_send_recv(i);

        spi_send_recv(0x0);
        spi_send_recv(0x10);

        DISPLAY_CHANGE_TO_DATA_MODE;

        for (j = 0; j < 16; j++)
        {
            c = textbuffer[i][j];
            if (c & 0x80)
                continue;

            for (k = 0; k < 8; k++)
            {
                displayBuff[i * 128 + j * 8 + k] &= ~font[c * 8 + k];
            }
        }
    }
}

//
// Author: Olof
// Slightly modified from example project
void display_buffer(int x, int size, uint8_t *data)
{
    int i, j;

    for (i = 0; i < 4; i++)
    {
        DISPLAY_CHANGE_TO_COMMAND_MODE;

        spi_send_recv(0x22);
        spi_send_recv(i);

        spi_send_recv(x & 0xF);
        spi_send_recv(0x10 | ((x >> 4) & 0xF));

        DISPLAY_CHANGE_TO_DATA_MODE;

        for (j = 0; j < size; j++)
            spi_send_recv(~data[i * size + j]);
    }
}

//
// Author: Olof
//
// Return binary with n amount of 1's in LSB
int extend_at_lsb(int n)
{
    int i;
    int res = 0x1;
    for (i = 0; i < n - 1; i++)
    {
        res = (res << 1) | 0x1;
    }
    return res;
}

//
// Author: Olof
void display_rect(int x, int y, int size)
{
    int i, j;
    int pageIndex = floor(y / 8);

    int bytePixelOffset = y - pageIndex * 8;

    for (i = 0; i < size; i++)
    {
        int pixelByte1 = 0x0;
        int pixelByte2 = 0x0;

        int temp = 0;
        for (j = 0; j < size; j++)
        {
            int pageOffset = floor((y + j) / 8) != pageIndex;
            if (pageOffset)
            {
                pixelByte2 |= (1 << temp++);
            }
            else
            {
                pixelByte1 |= (1 << (bytePixelOffset + j));
            }

            // displayBuff[pageIndex * 128 + x + i] = ~(extend_at_lsb(size) << bytePixelOffset);
        }
        displayBuff[pageIndex * 128 + x + i] &= ~pixelByte1;
        if (pixelByte2)
        {
            displayBuff[(pageIndex + 1) * 128 + x + i] &= ~pixelByte2;
        }

        // display_debug(&pixelByte1);
    }
}

//
// Author: Olof
void display_clear(void)
{
    int i;
    for (i = 0; i < 512; i++)
    {
        displayBuff[i] = 0xff;
    }
    display_buffer(0, 128, displayBuff);
}

// Author: Olof & Tobias
void draw_border(void)
{
    int i;
    for (i = 0; i < 4; i++)
    {
        displayBuff[i * 128] = 0x0;
        displayBuff[i * 128 + 127] = 0x0;
    }
    for (i = 0; i < 128; i++)
    {
        displayBuff[i] &= ~0x1;
        displayBuff[3 * 128 + i] &= ~0x80;
    }
}

// From example project
/* Helper function, local to this file.
   Converts a number to hexadecimal ASCII digits. */
static void num32asc(char *s, int n)
{
    int i;
    for (i = 28; i >= 0; i -= 4)
        *s++ = "0123456789ABCDEF"[(n >> i) & 15];
}

// From example project
#define ITOA_BUFSIZ (24)
char *itoaconv(int num)
{
    register int i, sign;
    static char itoa_buffer[ITOA_BUFSIZ];
    static const char maxneg[] = "-2147483648";

    itoa_buffer[ITOA_BUFSIZ - 1] = 0; /* Insert the end-of-string marker. */
    sign = num;                       /* Save sign. */
    if (num < 0 && num - 1 > 0)       /* Check for most negative integer */
    {
        for (i = 0; i < sizeof(maxneg); i += 1)
            itoa_buffer[i + 1] = maxneg[i];
        i = 0;
    }
    else
    {
        if (num < 0)
            num = -num;      /* Make number positive. */
        i = ITOA_BUFSIZ - 2; /* Location for first ASCII digit. */
        do
        {
            itoa_buffer[i] = num % 10 + '0'; /* Insert next digit. */
            num = num / 10;                  /* Remove digit from number. */
            i -= 1;                          /* Move index to next empty position. */
        } while (num > 0);
        if (sign < 0)
        {
            itoa_buffer[i] = '-';
            i -= 1;
        }
    }
    /* Since the loop always sets the index i to the next empty position,
     * we must add 1 in order to return a pointer to the first occupied position. */
    return (&itoa_buffer[i + 1]);
}
